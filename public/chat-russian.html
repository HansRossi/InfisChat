<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Русский чат | INFIS Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
  <!-- Пузырьки -->
  <div class="bubbles">
    <div class="bubble blue" style="left:10%; width:40px; height:40px; animation-duration:18s; --start:0.3;"></div>
    <div class="bubble pink" style="left:25%; width:25px; height:25px; animation-duration:22s; animation-delay:3s; --start:0.6;"></div>
    <div class="bubble purple" style="left:40%; width:60px; height:60px; animation-duration:25s; animation-delay:6s; --start:0.1;"></div>
    <div class="bubble blue" style="left:55%; width:20px; height:20px; animation-duration:20s; animation-delay:2s; --start:0.5;"></div>
    <div class="bubble pink" style="left:70%; width:50px; height:50px; animation-duration:30s; animation-delay:4s; --start:0.2;"></div>
    <div class="bubble purple" style="left:85%; width:35px; height:35px; animation-duration:26s; animation-delay:8s; --start:0.7;"></div>
  </div>

  <div class="container">
    <header>
      <a href="index.html">
        <img src="photos/logo-infis.png" alt="infis logo" class="header-logo"/>
      </a>
      <ul>
        <li><a href="general-chat.html">Назад к чатам</a></li>
        <li><a href="index.html">Главная</a></li>
      </ul>
    </header>

    <div class="chat-container">
      <div class="chat-header">
        <div class="chat-title">
          <img src="photos/ru.webp" alt="Российский флаг" class="chat-flag">
          <span>Русский чат</span>
          <span class="user-count" id="user-count">0</span>
        </div>
        <div class="header-buttons">
          <button class="name-btn" id="name-btn">Изменить имя</button>
          <button class="leave-btn" id="leave-btn">Выйти из чата</button>
        </div>
      </div>
      
      <div class="chat-content">
        <div class="users-sidebar">
          <h3 class="users-title">Участники</h3>
          <div class="user-list" id="user-list">
            <!-- Список пользователей будет здесь -->
          </div>
        </div>
        
        <div class="chat-main">
          <div class="messages-container" id="messages">
            <!-- Сообщения будут здесь -->
          </div>
          
          <div class="chat-input-container">
            <form class="chat-form" id="chat-form">
              <input type="text" class="message-input" id="message-input" placeholder="Введите сообщение..." autocomplete="off">
              <button type="submit" class="send-btn" id="send-btn">Отправить</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="notification" id="notification"></div>

  <script>
    // JavaScript код остается без изменений
    document.addEventListener('DOMContentLoaded', function() {
      // Подключение к серверу
      const socket = io();
      
      // Элементы DOM
      const messagesContainer = document.getElementById('messages');
      const messageInput = document.getElementById('message-input');
      const chatForm = document.getElementById('chat-form');
      const sendBtn = document.getElementById('send-btn');
      const leaveBtn = document.getElementById('leave-btn');
      const nameBtn = document.getElementById('name-btn');
      const userList = document.getElementById('user-list');
      const userCount = document.getElementById('user-count');
      const notification = document.getElementById('notification');
      
      // Переменные состояния
      let currentUser = '';
      const room = 'russian';
      let isConnected = false;
      
      // Функция показа уведомления
      function showNotification(text, type = 'info') {
        notification.textContent = text;
        notification.className = `notification show ${type}`;
        
        setTimeout(() => {
          notification.classList.remove('show');
        }, 3000);
      }
      
      // Запрос имени пользователя
      function getUserName() {
        let name = localStorage.getItem('chat_username');
        
        if (!name) {
          name = prompt('Введите ваше имя для чата:') || `Гость${Math.floor(Math.random() * 1000)}`;
          if (name) {
            localStorage.setItem('chat_username', name);
          }
        }
        
        return name;
      }
      
      // Изменение имени пользователя
      function changeUserName() {
        const newName = prompt('Введите новое имя:', currentUser);
        
        if (newName && newName.trim() && newName !== currentUser) {
          if (isConnected) {
            socket.emit('changeUsername', {
              oldUsername: currentUser,
              newUsername: newName.trim()
            });
          }
          
          currentUser = newName.trim();
          localStorage.setItem('chat_username', currentUser);
          showNotification(`Имя изменено на ${currentUser}`, 'success');
        }
      }
      
      // Подключение к чату
      function connectToChat() {
        currentUser = getUserName();
        
        if (!currentUser) {
          showNotification('Имя пользователя обязательно', 'error');
          return false;
        }
        
        socket.emit('joinChat', room, currentUser);
        isConnected = true;
        showNotification(`Вы вошли в чат как ${currentUser}`, 'success');
        return true;
      }
      
      // Форматирование времени
      function formatTime(date) {
        return new Date(date).toLocaleTimeString('ru-RU', {
          hour: '2-digit',
          minute: '2-digit'
        });
      }
      
      // Добавление сообщения в чат
      function addMessage(messageData) {
        const messageEl = document.createElement('div');
        messageEl.className = `message ${messageData.username === currentUser ? 'own' : ''}`;
        
        messageEl.innerHTML = `
          <div class="message-sender">${messageData.username}</div>
          <p class="message-text">${messageData.message}</p>
          <div class="message-time">${formatTime(messageData.timestamp || new Date())}</div>
        `;
        
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // Добавление системного сообщения
      function addSystemMessage(text) {
        const messageEl = document.createElement('div');
        messageEl.className = 'message system-message';
        messageEl.textContent = text;
        messagesContainer.appendChild(messageEl);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }
      
      // Обновление списка пользователей
      function updateUsersList(users) {
        userList.innerHTML = '';
        userCount.textContent = users.length;
        
        if (users.length === 0) {
          userList.innerHTML = '<div class="user-item">Нет участников</div>';
          return;
        }
        
        users.forEach(user => {
          const userEl = document.createElement('div');
          userEl.className = 'user-item';
          
          userEl.innerHTML = `
            <div class="user-avatar">${user.charAt(0).toUpperCase()}</div>
            <span>${user}</span>
          `;
          
          userList.appendChild(userEl);
        });
      }
      
      // Обработчик отправки сообщения
      chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        socket.emit('sendMessage', {
          chat: room,
          username: currentUser,
          message: message
        });
        
        messageInput.value = '';
      });
      
      // Обработчик выхода из чата
      leaveBtn.addEventListener('click', function() {
        if (isConnected) {
          socket.emit('leaveChat');
          isConnected = false;
        }
        
        window.location.href = 'general-chat.html';
      });
      
      // Обработчик изменения имени
      nameBtn.addEventListener('click', changeUserName);
      
      // Обработчики событий Socket.io
      socket.on('connect', function() {
        showNotification('Подключено к серверу');
        if (!connectToChat()) {
          // Если не удалось подключиться, попробуем снова через секунду
          setTimeout(() => connectToChat(), 1000);
        }
      });
      
      socket.on('disconnect', function() {
        showNotification('Отключено от сервера', 'error');
        isConnected = false;
        addSystemMessage('Потеряна связь с сервером. Попробуйте переподключиться.');
      });
      
      socket.on('connect_error', function(error) {
        showNotification('Ошибка подключения: ' + error.message, 'error');
      });
      
      socket.on('loadMessages', function(messages) {
        messagesContainer.innerHTML = '';
        
        if (messages.length === 0) {
          addSystemMessage('Чат пуст. Будьте первым, кто отправит сообщение!');
          return;
        }
        
        messages.forEach(message => {
          addMessage(message);
        });
      });
      
      socket.on('newMessage', function(message) {
        addMessage(message);
      });
      
      socket.on('userJoined', function(username) {
        addSystemMessage(`${username} присоединился к чату`);
      });
      
      socket.on('userLeft', function(username) {
        addSystemMessage(`${username} покинул чат`);
      });
      
      socket.on('usernameChanged', function(data) {
        addSystemMessage(`Пользователь ${data.oldUsername} теперь известен как ${data.newUsername}`);
      });
      
      socket.on('updateUsers', function(users) {
        updateUsersList(users);
      });
      
      // Фокус на поле ввода при загрузке
      messageInput.focus();
      
      // Обработка нажатия Ctrl+Enter для отправки сообщения
      messageInput.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
          chatForm.dispatchEvent(new Event('submit'));
        }
      });
    });
  </script>
</body>
</html>